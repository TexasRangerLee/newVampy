using UnityEngine;
using System.Collections;
using UnityEngine.Rendering;
using System;

[RequireComponent(typeof(Camera))]
public class VolumetricLightRenderer : MonoBehaviour
{
	public static event Action<VolumetricLightRenderer, Matrix4x4> PreRenderEvent;

	public static Mesh _pointLightMesh;
	public static Mesh _spotLightMesh;

	private Camera _camera;
	private CommandBuffer _preLightPass;

	private Matrix4x4 _viewProj;
	private Material _blitAddMaterial;
	private Material _bilateralBlurMaterial;

	[HideInInspector]public RenderTexture _volumeLightTexture;
	[HideInInspector]public RenderTexture _halfVolumeLightTexture;

	private RenderTexture _halfDepthBuffer;

	public CommandBuffer GlobalCommandBuffer { get { return _preLightPass; } }

	void Awake()
	{
		_camera = GetComponent<Camera>();
		if (_camera.actualRenderingPath == RenderingPath.Forward)
			_camera.depthTextureMode = DepthTextureMode.Depth;

		Shader shader = Shader.Find("Blit");
		if (shader == null)
			throw new Exception("Critical Error: \"Blit\" shader is missing.");
		_blitAddMaterial = new Material(shader);

		shader = Shader.Find("Blur");
		if (shader == null)
			throw new Exception("Critical Error: \"Blur\" shader is missing.");
		_bilateralBlurMaterial = new Material(shader);

		_preLightPass = new CommandBuffer();
		_preLightPass.name = "PreLight";

		ChangeResolution();

		if (_pointLightMesh == null)
		{
			GameObject go = GameObject.CreatePrimitive(PrimitiveType.Sphere);
			_pointLightMesh = go.GetComponent<MeshFilter>().sharedMesh;
			Destroy(go);
		}

		if (_spotLightMesh == null)
			_spotLightMesh = CreateSpotLightMesh();
	}
		
	void OnEnable()
	{
		//_camera.RemoveAllCommandBuffers();
		if(_camera.actualRenderingPath == RenderingPath.Forward)
			_camera.AddCommandBuffer(CameraEvent.AfterDepthTexture, _preLightPass);
		else
			_camera.AddCommandBuffer(CameraEvent.BeforeLighting, _preLightPass);
	}

	void OnDisable()
	{
		//_camera.RemoveAllCommandBuffers();
		if(_camera.actualRenderingPath == RenderingPath.Forward)
			_camera.RemoveCommandBuffer(CameraEvent.AfterDepthTexture, _preLightPass);
		else
			_camera.RemoveCommandBuffer(CameraEvent.BeforeLighting, _preLightPass);
	}
		
	void ChangeResolution()
	{
		int width = _camera.pixelWidth;
		int height = _camera.pixelHeight;

		if (_volumeLightTexture != null)
			Destroy(_volumeLightTexture);

		_volumeLightTexture = new RenderTexture(width, height, 0, RenderTextureFormat.ARGBHalf);
		_volumeLightTexture.name = "VolumeLightBuffer";
		_volumeLightTexture.filterMode = FilterMode.Bilinear;

		if (_halfDepthBuffer != null)
			Destroy(_halfDepthBuffer);
		if (_halfVolumeLightTexture != null)
			Destroy(_halfVolumeLightTexture);

		_halfVolumeLightTexture = new RenderTexture(width / 2, height / 2, 0, RenderTextureFormat.ARGBHalf);
		_halfVolumeLightTexture.name = "VolumeLightBufferHalf";
		_halfVolumeLightTexture.filterMode = FilterMode.Bilinear;

		_halfDepthBuffer = new RenderTexture(width / 2, height / 2, 0, RenderTextureFormat.RFloat);
		_halfDepthBuffer.name = "VolumeLightHalfDepth";
		_halfDepthBuffer.Create();
		_halfDepthBuffer.filterMode = FilterMode.Point;
	}

	public void OnPreRender()
	{
		// use very low value for near clip plane to simplify cone/frustum intersection 
		Matrix4x4 proj = Matrix4x4.Perspective(_camera.fieldOfView, _camera.aspect, 0.01f, _camera.farClipPlane);
		proj = GL.GetGPUProjectionMatrix(proj, true);

		_viewProj = proj * _camera.worldToCameraMatrix;

		_preLightPass.Clear();

		bool dx11 = SystemInfo.graphicsShaderLevel > 40;

		Texture nullTexture = null;

		_preLightPass.Blit(nullTexture, _halfDepthBuffer, _bilateralBlurMaterial, dx11 ? 4 : 10);

		_preLightPass.SetRenderTarget(_halfVolumeLightTexture);
		
		_preLightPass.ClearRenderTarget(false, true, new Color(0, 0, 0, 1));

		_bilateralBlurMaterial.SetTexture("_HalfResDepthBuffer", _halfDepthBuffer);
		_bilateralBlurMaterial.SetTexture("_HalfResColor", _halfVolumeLightTexture);

		if (PreRenderEvent != null)
			PreRenderEvent(this, _viewProj);
	}

	[ImageEffectOpaque]
	public void OnRenderImage(RenderTexture source, RenderTexture destination)
	{
		RenderTexture temp = RenderTexture.GetTemporary(_halfVolumeLightTexture.width, _halfVolumeLightTexture.height, 0, RenderTextureFormat.ARGBHalf);
		temp.filterMode = FilterMode.Bilinear;

		// horizontal bilateral blur at half res
		Graphics.Blit(_halfVolumeLightTexture, temp, _bilateralBlurMaterial, 2);

		// vertical bilateral blur at half res
		Graphics.Blit(temp, _halfVolumeLightTexture, _bilateralBlurMaterial, 3);

		// upscale to full res
		Graphics.Blit(_halfVolumeLightTexture, _volumeLightTexture, _bilateralBlurMaterial, 5);
		RenderTexture.ReleaseTemporary(temp);

		// add volume light buffer to rendered scene
		_blitAddMaterial.SetTexture("_Source", source);
		Graphics.Blit(_volumeLightTexture, destination, _blitAddMaterial, 0);
	}

	void Update()
	{
		if ((_volumeLightTexture.width != _camera.pixelWidth || _volumeLightTexture.height != _camera.pixelHeight))
			ChangeResolution();
	}

	/// Allows the camera to see volumetric lighting on spotlights.
	private Mesh CreateSpotLightMesh()
	{
		// copy & pasted from other project, the geometry is too complex, should be simplified
		Mesh mesh = new Mesh();

		const int segmentCount = 16;
		Vector3[] vertices = new Vector3[2 + segmentCount * 3];
		Color32[] colors = new Color32[2 + segmentCount * 3];

		vertices[0] = new Vector3(0, 0, 0);
		vertices[1] = new Vector3(0, 0, 1);

		float angle = 0;
		float step = Mathf.PI * 2.0f / segmentCount;
		float ratio = 0.9f;

		for (int i = 0; i < segmentCount; ++i)
		{
			vertices[i + 2] = new Vector3(-Mathf.Cos(angle) * ratio, Mathf.Sin(angle) * ratio, ratio);
			colors[i + 2] = new Color32(255, 255, 255, 255);
			vertices[i + 2 + segmentCount] = new Vector3(-Mathf.Cos(angle), Mathf.Sin(angle), 1);
			colors[i + 2 + segmentCount] = new Color32(255, 255, 255, 0);
			vertices[i + 2 + segmentCount * 2] = new Vector3(-Mathf.Cos(angle) * ratio, Mathf.Sin(angle) * ratio, 1);
			colors[i + 2 + segmentCount * 2] = new Color32(255, 255, 255, 255);
			angle += step;
		}

		mesh.vertices = vertices;
		mesh.colors32 = colors;

		int[] indices = new int[segmentCount * 3 * 2 + segmentCount * 6 * 2];
		int index = 0;

		for (int i = 2; i < segmentCount + 1; ++i)
		{
			indices[index++] = 0;
			indices[index++] = i;
			indices[index++] = i + 1;
		}

		indices[index++] = 0;
		indices[index++] = segmentCount + 1;
		indices[index++] = 2;

		for (int i = 2; i < segmentCount + 1; ++i)
		{
			indices[index++] = i;
			indices[index++] = i + segmentCount;
			indices[index++] = i + 1;

			indices[index++] = i + 1;
			indices[index++] = i + segmentCount;
			indices[index++] = i + segmentCount + 1;
		}

		indices[index++] = 2;
		indices[index++] = 1 + segmentCount;
		indices[index++] = 2 + segmentCount;

		indices[index++] = 2 + segmentCount;
		indices[index++] = 1 + segmentCount;
		indices[index++] = 1 + segmentCount + segmentCount;

		//------------
		for (int i = 2 + segmentCount; i < segmentCount + 1 + segmentCount; ++i)
		{
			indices[index++] = i;
			indices[index++] = i + segmentCount;
			indices[index++] = i + 1;

			indices[index++] = i + 1;
			indices[index++] = i + segmentCount;
			indices[index++] = i + segmentCount + 1;
		}

		indices[index++] = 2 + segmentCount;
		indices[index++] = 1 + segmentCount * 2;
		indices[index++] = 2 + segmentCount * 2;

		indices[index++] = 2 + segmentCount * 2;
		indices[index++] = 1 + segmentCount * 2;
		indices[index++] = 1 + segmentCount * 3;

		////-------------------------------------
		for (int i = 2 + segmentCount * 2; i < segmentCount * 3 + 1; ++i)
		{
			indices[index++] = 1;
			indices[index++] = i + 1;
			indices[index++] = i;
		}

		indices[index++] = 1;
		indices[index++] = 2 + segmentCount * 2;
		indices[index++] = segmentCount * 3 + 1;

		mesh.triangles = indices;
		mesh.RecalculateBounds();

		return mesh;
	}
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    